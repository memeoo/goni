# 키움 조건 검색식 테스트 최종 보고서

**테스트 날짜**: 2025-11-30  
**테스트 대상**: 신고가 돌파, 대왕개미 단타론 조건식  
**결론**: ❌ 조건식 검색 기능 미작동

---

## 📋 테스트 요약

| 항목 | 상태 | 상세 |
|------|------|------|
| **조건식 목록 조회** | ✅ 성공 | 8개 조건식 정상 조회 |
| **신고가 돌파 검색** | ❌ 실패 | CNSRREQ 응답 수신 안 됨 |
| **대왕개미 단타 검색** | ❌ 실패 | CNSRREQ 응답 수신 안 됨 |
| **기타 조건식 검색** | ❌ 실패 | 모든 조건식 동일 증상 |

---

## 🔍 상세 분석

### 조건식 목록 조회 ✅

```
WebSocket 연결 → LOGIN ✅ → CNSRLST 응답 ✅ 
조회된 조건식 8개:
  - ID:0 장기횡보1_이격도기준
  - ID:1 장기횡보2_대상변경
  - ID:2 단타_BASIC_SIMPLE01
  - ID:3 단타_BASIC_SIMPLE01_코스피
  - ID:4 단타_BASIC_SIMPLE01_코스피_02
  - ID:5 대왕개미단타 ⭐
  - ID:6 창원개미_단타
  - ID:7 신고가 돌파 ⭐
```

### 조건식 검색 요청 ❌

```
시간 순서 | 이벤트
---------|------------------------------------------
00:30:46 | CNSRREQ 요청 전송 ✅
         | "{"trnm":"CNSRREQ","seq":"7",...}"
---------|------------------------------------------
00:30:58 | PING 수신 ✅ (10초 후)
---------|------------------------------------------
00:31:03 | 타임아웃 ❌ (15초 대기)
         | CNSRREQ 응답 미수신
```

### 네트워크 분석

```python
# 요청 파라미터
{
    'trnm': 'CNSRREQ',
    'seq': '7',                # 조건식 ID
    'search_type': '0',        # 일반 조회
    'stex_tp': '%',           # 전체 거래소
    'cont_yn': 'N',           # 연속조회 안 함
    'next_key': ''            # 연속조회키 없음
}

# 기대 응답
{
    'trnm': 'CNSRREQ',
    'return_code': 0,
    'data': [{종목들...}]
}

# 실제 상황
수신된 응답: PING만 계속 수신
                ↓
            타임아웃
```

---

## 🚨 근본 원인 분석

### 확실한 사실
1. ✅ API 토큰 발급 정상
2. ✅ WebSocket 연결 정상 (PING 응답)
3. ✅ 로그인 정상
4. ✅ CNSRREQ 요청 전송 정상
5. ❌ CNSRREQ 응답 미수신

### 가능한 원인

| 원인 | 확률 | 근거 |
|------|------|------|
| 키움 API 서버 장애 | 🔴 높음 | 모든 조건식 검색 실패 |
| 조건식 비활성화 | 🔴 높음 | 목록에는 있지만 검색 불가 |
| API 권한/할당량 문제 | 🟡 중간 | 특정 계정의 권한 문제 가능 |
| 스트림 데이터 오버플로우 | 🟡 중간 | 다른 WebSocket 세션 간섭 |
| 프로토콜 버전 불일치 | 🟢 낮음 | CNSRLST는 정상 작동 |

---

## 📊 스케줄러 영향 분석

### 현재 설정

```python
# back/app/scheduler.py

# Job 1: 신고가 돌파 (조건 ID: 7)
update_rec_stocks_job()
- 시간: 매일 15:37 (수정됨: 15:37, 원래: 18:10)
- 알고리즘 ID: 1
- 상태: ❌ 작동 불가

# Job 2: 대왕개미 단타론 (조건 ID: 5)
update_dae_wangkaemi_stocks_job()
- 시간: 매일 14:22 (수정됨: 14:22, 원래: 18:15)
- 알고리즘 ID: 2
- 상태: ❌ 작동 불가
```

### 영향도
```
조건식 검색 실패
         ↓
RecommendationService.search_and_update_rec_stocks() 실패
         ↓
rec_stocks 테이블 데이터 미업데이트
         ↓
프론트엔드 추천 종목 표시 안 됨
```

---

## 🛠️ 해결 방안

### 1단계: 즉시 조치 (우선순위: 높음)

```bash
# 1. 키움증권 고객센터 연락
   - 조건식 검색 API 서버 상태 확인
   - 계정별 권한 확인
   - API 버전 변경 사항 확인

# 2. 대체 방법 검토
   - 키움 Mobile API 조건식 활용
   - 직접 기술적 분석으로 조건식 대체 개발
   - 다른 증권사 API 검토
```

### 2단계: 코드 개선 (우선순위: 중간)

```python
# analyze/lib/kiwoom.py 개선사항

1. 응답 대기 로직 강화
   - CNSRREQ 타임아웃 증가 (15초 → 30초)
   - 재시도 로직 추가 (최대 3회)
   - 에러 응답 상세 로깅

2. WebSocket 안정성 개선
   - 주기적 헬스체크 추가
   - 자동 재연결 메커니즘
   - 동시성 제어

3. 모니터링 강화
   - 모든 응답 로깅 (특히 CNSRREQ)
   - 타임아웃 통계 수집
   - 알림 시스템 구축

예시:
```python
async def request_condition_search(self, condition_id, ...):
    max_retries = 3
    for attempt in range(max_retries):
        response = await self._send_condition_search(condition_id, ...)
        if response:
            return response
        await asyncio.sleep(2 ** attempt)  # 지수 백오프
    
    logger.error(f"Condition search failed after {max_retries} retries")
    return None
```

### 3단계: 운영 개선 (우선순위: 중간)

```
1. 대시보드 모니터링
   - 스케줄러 작업 성공/실패 추적
   - API 응답 시간 모니터링
   - 일일 리포트 자동화

2. 장애 대응 절차
   - 조건식 검색 실패 시 알림
   - 수동 업데이트 프로세스
   - 데이터 동기화 스크립트

3. 백업 방안
   - 어제 데이터 캐싱
   - 수동 추천 종목 입력 UI
```

---

## 💡 권장 조치

### 즉시 (오늘)
1. ☎️ 키움증권 기술지원팀 연락
2. 📝 문제 재현 방법 상세 기록
3. 🔧 API 상태 확인

### 단기 (이번주)
1. ✅ 키움 고객센터 응답 대기
2. 🔧 코드 개선 작업 시작
3. 📊 별도 데이터 소스 검토

### 장기 (이번달)
1. 📦 대체 방안 구현
2. 🧪 타 API 테스트
3. 🚀 프로덕션 전환

---

## 📝 결론

키움 조건 검색식 API의 **CNSRREQ (조건식 검색) 기능이 현재 작동하지 않습니다**.

- **조건식 목록 조회**: ✅ 정상
- **조건식 검색**: ❌ 미작동
- **신고가 돌파**: ❌ 미작동
- **대왕개미 단타론**: ❌ 미작동

### 현재 상태
- 스케줄러가 설정되어 있지만 실행 불가능
- 추천 종목 기능 완전 중단
- 사용자에게 데이터 표시 불가능

### 필수 해결 사항
1. 키움 API 서버 상태 확인 필요
2. 대체 방안 구현 필요
3. 모니터링 및 알림 시스템 구축 필요

**최종 진단**: 🚨 **긴급 조치 필요**

