# 조건 검색식 테스트 리포트

## 테스트 개요
두 조건 검색식의 정상 작동 여부를 검증하기 위한 테스트 수행
- **테스트 일시**: 2025-12-01 10:16:20 (장 종료 후 시간)
- **테스트 환경**: 실전투자 모드 (use_mock=False)
- **대상 조건식**:
  1. 대왕개미 단타론 (ID: 5)
  2. 신고가 따라잡기 (ID: 7)

---

## 테스트 결과 요약

### 테스트 1: Kiwoom API 연결
✅ **성공**
- Kiwoom API 토큰 발급 성공
- 토큰 만료 시간: 2025-12-02 10:11:17

### 테스트 2: 조건 검색 목록 조회
✅ **성공**
- 조건 검색 목록 조회: 8개 조건식 확인
- 대왕개미 단타론 (ID: 5) **발견** ✓
- 신고가 따라잡기 (ID: 7) **발견** ✓

**조회된 조건식 목록**:
```
ID: 0   | 장기횡보1_이격도기준
ID: 1   | 장기횡보2_대상변경
ID: 2   | 단타_BASIC_SIMPLE01
ID: 3   | 단타_BASIC_SIMPLE01_코스피
ID: 4   | 단타_BASIC_SIMPLE01_코스피_02
ID: 5   | 대왕개미단타                    (대왕개미 단타론)
ID: 6   | 창원개미_단타
ID: 7   | 신고가 돌파                     (신고가 따라잡기)
```

### 테스트 3: 조건식별 종목 검색
❌ **실패** (WebSocket 응답 타임아웃)

#### 3-1. ID 5 (대왕개미 단타론) 검색
- **상태**: 조건식 검색 요청 타임아웃
- **소요 시간**: 약 20초
- **로그**:
  ```
  [10:16:22] WebSocket 연결 성공
  [10:16:23] 조건 검색 요청 시작 (일반): condition_id=5, stex_tp=%
  [10:16:43] 에러 - 조건 검색 요청 타임아웃: condition_id=5
  ```

#### 3-2. ID 7 (신고가 따라잡기) 검색
- **상태**: 조건식 검색 요청 타임아웃
- **소요 시간**: 약 20초
- **로그**:
  ```
  [10:16:43] WebSocket 연결 성공
  [10:16:44] 조건 검색 요청 시작 (일반): condition_id=7, stex_tp=%
  [10:17:04] 에러 - 조건 검색 요청 타임아웃: condition_id=7
  ```

### 테스트 4: RecommendationService 통합
❌ **실패**
- 신고가 따라잡기 (ID: 7): 종목 검색 실패
- 대왕개미 단타론 (ID: 5): 종목 검색 실패

---

## 문제 진단

### 🔴 주요 문제: WebSocket 응답 타임아웃

**근본 원인**: 테스트 시간대(10:16, 장 종료 후)에는 Kiwoom API가 조건 검색 결과를 제공하지 않음

**상세 분석**:
```
현재 시간: 2025-12-01 10:16 (월요일 10시 16분)
장 운영 상태: CLOSED (10:16은 장 시간 이후)
조건 검색 요청: ❌ 장 시간 외에는 응답 제공 안 됨
```

### 코드 위치
| 파일 | 라인 | 설명 |
|------|------|------|
| `/home/ubuntu/goni/analyze/lib/kiwoom.py` | 191-297 | `request_condition_search()` - WebSocket 응답 대기 로직 (타임아웃 20초) |
| `/home/ubuntu/goni/analyze/lib/kiwoom.py` | 885-950 | `search_condition()` - 조건 검색 진입점 |
| `/home/ubuntu/goni/back/app/scheduler.py` | 26-72 | `update_rec_stocks_job()` - 신고가 따라잡기 스케줄러 |
| `/home/ubuntu/goni/back/app/scheduler.py` | 75-121 | `update_dae_wangkaemi_stocks_job()` - 대왕개미 스케줄러 |

---

## 결론

### 조건 검색식의 현황
1. ✅ 두 조건식이 모두 Kiwoom API에 등록되어 있음 (ID: 5, 7)
2. ✅ API 토큰 발급 및 기본 연결은 정상 작동
3. ✅ 조건 검색 목록 조회는 정상 작동
4. ⚠️ **조건식으로 종목 검색**: 장 시간 외에는 응답 미제공

### 최종 판정
| 구분 | 상태 | 이유 |
|------|------|------|
| **조건식 등록** | ✅ 정상 | 두 조건식 모두 Kiwoom에 등록 |
| **API 연결** | ✅ 정상 | 토큰 발급 및 기본 통신 정상 |
| **조건식 검색** | ⚠️ 시간대 제약 | 장 시간(09:00~15:30)에만 응답 |
| **전체 평가** | ⚠️ 조건부 정상 | **장 시간에만 정상 작동** |

---

## 권장사항

### 검증 방법
장 시간(09:00~15:30) 중에 다시 테스트하여 확인:
```bash
source /home/ubuntu/goni/venv/bin/activate
python /home/ubuntu/goni/test_condition_search.py
```

### 단기 개선사항
1. **응답 타임아웃 증가** - `/home/ubuntu/goni/analyze/lib/kiwoom.py` 라인 271
2. **에러 메시지 개선** - 장 시간 여부 명시

### 중기 개선사항
1. 장 운영 여부 사전 확인
2. 실시간 조회 모드(search_type='1') 테스트
3. 캐싱 메커니즘 도입

---

## 테스트 실행 정보

**테스트 파일**: `/home/ubuntu/goni/test_condition_search.py`

**실행 명령**:
```bash
cd /home/ubuntu/goni
source venv/bin/activate
python test_condition_search.py
```

---

## 주의사항

- 본 테스트는 **장 종료 후** 실행되었으므로, 장 중 재테스트 필요
- 스케줄러는 설정된 시간(18:10, 18:15)에 자동으로 실행되지만, 장 종료 후이므로 응답 미제공 가능
- Kiwoom API의 정책에 따라 특정 시간대에만 조건 검색 제공
