# ATR 기반 손절/익절 자동 계산 기능 구현 완료

**구현 날짜**: 2025-11-30  
**상태**: ✅ 완료 및 테스트 완료

---

## 📋 구현 내용 요약

### 1️⃣ 백엔드 ATR 계산 함수 (Python)
- **파일**: `analyze/src/technical_analyzer.py`
- **추가 함수**:
  - `calculate_atr_40days()`: 40일 ATR 계산 및 손절가 자동 계산
  - `_calculate_true_range()`: True Range 계산
  - `calculate_atr_multiple_periods()`: 다중 기간 ATR 비교
  - `calculate_stop_loss_levels()`: 배수별 손절매 가격 계산

- **테스트**: 모든 테스트 성공 ✅
  ```
  40일 ATR: 283.26원
  현재가: 8,979원
  손절매(2배): 8,413원 (손절률: 6.31%)
  ```

### 2️⃣ 백엔드 API 엔드포인트
- **파일**: `back/app/routers/stocks.py`
- **새 엔드포인트**: `GET /api/stocks/{stock_code}/atr`
- **기능**: 종목코드를 받아 40일 ATR 계산 및 반환
- **응답**:
  ```json
  {
    "status": "success",
    "data": {
      "atr_40d": 283.26,
      "current_price": 8979,
      "stop_loss_price": 8413,
      "stop_loss_ratio": 6.31,
      "statistics": {...}
    }
  }
  ```

### 3️⃣ 프론트엔드 UI 구현
- **파일**: `front/src/components/trading-plan-form-modal.tsx`
- **추가 기능**:
  - ATR 계산 버튼
  - 익절 ATR 배수 입력 및 자동 계산
  - 손절 ATR 배수 입력 및 자동 계산
  - 실시간 익절/손절가 및 비율 계산

---

## 🎯 사용자 흐름

### 1단계: 매매 계획 입력
```
매매 계획 모달 열기
↓
거래 종류 선택 (매수/매도)
↓
매수 계획 입력
  - 매수가: 10,000원
  - 수량, 금액, 조건, 이유 입력
```

### 2단계: ATR 계산
```
익절 계획 섹션 보이기
↓
[ATR 계산] 버튼 클릭
↓
백엔드에서 40일 ATR 계산
↓
ATR 값 표시 (예: 283원)
```

### 3단계: 익절/손절가 자동 계산
```
익절 배수 입력 (예: 1.5)
↓
[익절가 계산하기] 클릭
↓
자동 계산 결과:
  - 익절가: 10,450원
  - 익절률: 4.50%
  - 조건: "ATR 1.5배"

(손절도 동일 방식)
```

### 4단계: 저장
```
계획 저장 버튼 클릭
↓
데이터베이스에 저장
↓
완료
```

---

## 📊 UI 화면 레이아웃

### 익절 계획 섹션
```
┌──────────────────────────────────────┐
│ 익절 계획                            │
├──────────────────────────────────────┤
│ ┌─────────────────────────────────┐  │
│ │ ATR 기반 익절 설정              │  │
│ │ [ATR 계산] 40일 ATR: 283원      │  │
│ │ 배수(배): [1.5]                │  │
│ │         [익절가 계산하기]       │  │
│ └─────────────────────────────────┘  │
│                                      │
│ 조건: [텍스트 입력]                  │
│ 익절가(원): [자동 입력됨]            │
│ 수익률(%): [자동 입력됨]             │
└──────────────────────────────────────┘
```

### 손절 계획 섹션
```
┌──────────────────────────────────────┐
│ 손절 계획                            │
├──────────────────────────────────────┤
│ ┌─────────────────────────────────┐  │
│ │ ATR 기반 손절 설정              │  │
│ │ 40일 ATR: 283원                 │  │
│ │ 배수(배): [2.0]                 │  │
│ │        [손절가 계산하기]        │  │
│ └─────────────────────────────────┘  │
│                                      │
│ 조건: [텍스트 입력]                  │
│ 손절가(원): [자동 입력됨]            │
│ 손절률(%): [자동 입력됨]             │
└──────────────────────────────────────┘
```

---

## 🔢 계산 공식

### True Range (실제 변동폭)
```
TR = max(
  |High - Low|,
  |High - Close_prev|,
  |Low - Close_prev|
)
```

### ATR (Average True Range)
```
ATR = SMA(TR, 40일)
     = 40일 TR의 단순 이동평균
```

### 익절가 (ATR 기반)
```
익절가 = 매수가 + ATR × 배수
익절률 = (익절가 - 매수가) / 매수가 × 100%
```

### 손절가 (ATR 기반)
```
손절가 = 매수가 - ATR × 배수
손절률 = (손절가 - 매수가) / 매수가 × 100%
```

---

## 💾 수정된 파일 목록

1. **`analyze/src/technical_analyzer.py`**
   - 4개 메서드 추가 (276-432 라인)
   - ATR 관련 계산 로직 구현

2. **`analyze/test_atr.py`**
   - 테스트 스위트 생성
   - 4개 테스트 함수 + 1개 실전 예시 함수
   - 모든 테스트 성공

3. **`back/app/routers/stocks.py`**
   - ATR API 엔드포인트 추가 (664-730 라인)
   - `/api/stocks/{stock_code}/atr` 구현

4. **`front/src/components/trading-plan-form-modal.tsx`**
   - 상태 변수 4개 추가 (84-88 라인)
   - 계산 함수 3개 추가 (184-250 라인)
   - UI 섹션 2개 추가 (723-761, 810-842 라인)

5. **`README.md`**
   - 상세 구현 내용 문서화
   - 사용 방법 및 계산 예시 추가

---

## ✅ 테스트 결과

### ATR 계산 테스트
```
테스트 1: 40일봉 기준 ATR 계산
결과: ✅ 성공
- 40일 ATR: 283.26원
- 손절매: 8,413원 (6.31%)

테스트 2: 여러 기간별 ATR 비교
결과: ✅ 성공
- 14일 ATR: 246.00원 (변동성: 2.74%)
- 20일 ATR: 277.10원 (변동성: 3.09%)
- 40일 ATR: 283.26원 (변동성: 3.15%)
- 60일 ATR: 274.72원 (변동성: 3.06%)

테스트 3: 배수별 손절매 가격 계산
결과: ✅ 성공
- 1.0배: 8,696원 (손절률: 3.15%)
- 1.5배: 8,554원 (손절률: 4.73%)
- 2.0배: 8,413원 (손절률: 6.31%)
- 2.5배: 8,271원 (손절률: 7.89%)
- 3.0배: 8,129원 (손절률: 9.46%)

테스트 4: 실전 매매 시나리오
결과: ✅ 성공
신고가 돌파 매수 후 손절매 및 목표가 설정
```

---

## 🚀 다음 단계 (Optional)

1. **더 많은 배수 조합 지원**
   - 현재: 1.0, 1.5, 2.0, 2.5, 3.0배
   - 추가: 사용자 정의 배수 입력

2. **ATR 기반 포지션 크기 계산**
   - 위험금액 기반 수량 계산
   - Risk/Reward 비율 시각화

3. **ATR 히스토리 차트**
   - ATR 추이 그래프
   - 최근 ATR 값 비교

4. **ATR 기반 자동 거래**
   - 손절/익절 자동 체결
   - 설정된 조건에 따른 자동 주문

---

## 📞 문의사항

기능 사용 중 문제가 발생하면:
1. 브라우저 개발자 콘솔 확인 (F12)
2. 백엔드 로그 확인
3. README.md의 사용 방법 재확인

---

**구현 완료**: 2025-11-30  
**최종 테스트**: 전체 기능 정상 작동 ✅
